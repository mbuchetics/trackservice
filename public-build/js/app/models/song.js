define(["order!libs.jquery","order!libs.underscore","order!libs.backbone","utils"],function(a,b,c,d){var e=c.Model.extend({like:function(){d.likeSong(this.get("songId"),CurrentUser.get("id"))}},{create:function(a,b){var c=new e;return c.set({songId:a._id,artist:a.artist,title:a.title,count:a.count,percentage:b>0?a.count/b*95:0}),a.spotify&&c.set({spotify:a.spotify}),c},createFromLike:function(a){var b=new e;return b.set({songId:a._id,artist:a.artist,title:a.title,time:d.getTimeStr(new Date(a.time),!0)}),a.spotify&&b.set({spotify:a.spotify}),b}}),f=c.Collection.extend({model:e,fetchTopFromServer:function(c,f){var g=this;d.log("fetching top songs: "+c),a.getJSON("api/songs/top_plays",{count:f,since:d.getDateAgo(c).toString()},function(a){g.reset(b.map(a,function(b){return e.create(b,a[0].count)}))})},fetchPopularFromServer:function(c,f){var g=this;d.log("fetching popular songs"),a.getJSON("api/songs/top_likes",{count:f,since:d.getDateAgo(c).toString()},function(a){g.reset(b(a).select(function(a){return a.count>0}).map(function(b){return e.create(b,a[0].count)}))})},fetchLikedFromServer:function(c,f){var g=this;d.log("fetching liked songs"),a.getJSON("api/likes",{user:c,count:f},function(a){g.reset(b.map(a,function(a){return e.createFromLike(a)}))})}});return{Song:e,Songs:f}})